<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Karte – Richtstätten Oberösterreichs</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
</head>
<body>
  <header>
    <h1>Karte – Richtstätten Oberösterreichs</h1>
    <nav>
      <a href="index.html">Start</a> •
      <a href="ueber.html">Über</a> •
      <a href="kontakt.html">Kontakt</a>
    </nav>
  </header>
  <div id="map"></div>
  <script>
    const map = L.map('map').setView([48.15, 13.95], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>-Mitwirkende'
    }).addTo(map);

    const shadowUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png';
    const iconRed   = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',   shadowUrl, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
    const iconGold  = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png',  shadowUrl, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
    const iconBlue  = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',  shadowUrl, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
    const iconGreen = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', shadowUrl, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});
    const iconBlack = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png', shadowUrl, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});

    function iconFor(kat){
      switch(kat){
        case 'Richtstätten': return iconRed;
        case 'Galgenhäuser':
        case 'Abdecker': return iconGold;
        case 'Kleindenkmäler': return iconBlue;
        case 'Flurnamen': return iconGreen;
        case 'Pranger': return iconBlack;
        default: return iconBlack;
      }
    }

    // Cluster je Kategorie (Filterbar)
    const clusters = {
      'Richtstätten': L.markerClusterGroup(),
      'Galgenhäuser': L.markerClusterGroup(),
      'Abdecker': L.markerClusterGroup(),
      'Kleindenkmäler': L.markerClusterGroup(),
      'Flurnamen': L.markerClusterGroup(),
      'Pranger': L.markerClusterGroup()
    };
    Object.values(clusters).forEach(c => c.addTo(map));
    L.control.layers(null, clusters, {collapsed:false}).addTo(map);

    Papa.parse('https://raw.githubusercontent.com/wolfundrabe/richtstaetten-ooe/main/daten/richtstaetten.csv?v=' + Date.now(), {

      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        results.data.forEach(row => {
          const lat = parseFloat(row.lat);
          const lng = parseFloat(row.lng);
          const kat = (row.kategorie || '').trim();
          if (isNaN(lat) || isNaN(lng) || !(kat in clusters)) return;

          const name = row.name || 'Ohne Titel';
          const beschr = (row.beschreibung || '').replace(/\n/g,'<br>');
          const link = row.link ? `<br><a href="${row.link}">Mehr erfahren →</a>` : '';
          const popup = `<b>${name}</b><br>${beschr}${link}`;

          const marker = L.marker([lat, lng], { icon: iconFor(kat) }).bindPopup(popup);
          clusters[kat].addLayer(marker);
        });
      }
    });

    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `
        <div class="title">Kategorien</div>
        <div class="item"><span class="swatch red"></span> Richtstätten</div>
        <div class="item"><span class="swatch gold"></span> Galgenhäuser / Abdecker</div>
        <div class="item"><span class="swatch blue"></span> Kleindenkmäler</div>
        <div class="item"><span class="swatch green"></span> Flurnamen</div>
        <div class="item"><span class="swatch black"></span> Pranger</div>`;
      return div;
    };
    legend.addTo(map);
  </script>
  <footer>© Richtstätten Oberösterreichs</footer>
</body>
</html>
